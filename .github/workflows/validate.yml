name: Validation & Quality Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18'

jobs:
  validate:
    name: ğŸ” Validate Project Structure
    runs-on: ubuntu-latest
    
    outputs:
      has-package-json: ${{ steps.check-files.outputs.has-package-json }}
      has-tsconfig: ${{ steps.check-files.outputs.has-tsconfig }}
      project-name: ${{ steps.check-package.outputs.project-name }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: Check essential files
      id: check-files
      run: |
        echo "ğŸ” Checking essential project files..."
        
        # Essential files check
        essential_files=(
          "package.json"
          "README.md"
          ".gitignore"
        )
        
        optional_files=(
          "tsconfig.json"
          "vite.config.ts"
          "index.html"
          "src/index.tsx"
          "src/App.tsx"
        )
        
        missing_essential=()
        missing_optional=()
        
        for file in "${essential_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file exists (essential)"
          else
            echo "âŒ $file missing (essential)"
            missing_essential+=("$file")
          fi
        done
        
        for file in "${optional_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file exists (optional)"
          else
            echo "âš ï¸ $file missing (optional)"
            missing_optional+=("$file")
          fi
        done
        
        # Set outputs
        if [ -f "package.json" ]; then
          echo "has-package-json=true" >> $GITHUB_OUTPUT
        else
          echo "has-package-json=false" >> $GITHUB_OUTPUT
        fi
        
        if [ -f "tsconfig.json" ]; then
          echo "has-tsconfig=true" >> $GITHUB_OUTPUT
        else
          echo "has-tsconfig=false" >> $GITHUB_OUTPUT
        fi
        
        # Report results
        if [ ${#missing_essential[@]} -gt 0 ]; then
          echo "ï¿½ Missing essential files: ${missing_essential[*]}"
          exit 1
        else
          echo "âœ… All essential files present"
        fi
        
        if [ ${#missing_optional[@]} -gt 0 ]; then
          echo "ğŸ“ Missing optional files: ${missing_optional[*]}"
        fi
        
    - name: Validate package.json
      id: check-package
      if: steps.check-files.outputs.has-package-json == 'true'
      run: |
        echo "ğŸ“¦ Validating package.json..."
        
        if ! node -e "JSON.parse(require('fs').readFileSync('package.json', 'utf8'))"; then
          echo "âŒ package.json is not valid JSON"
          exit 1
        fi
        
        PROJECT_NAME=$(node -p "JSON.parse(require('fs').readFileSync('package.json', 'utf8')).name || 'unknown'")
        echo "project-name=$PROJECT_NAME" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ Project name: $PROJECT_NAME"
        
        # Check for required fields
        REQUIRED_FIELDS=("name" "version")
        for field in "${REQUIRED_FIELDS[@]}"; do
          if node -e "const pkg = JSON.parse(require('fs').readFileSync('package.json', 'utf8')); if (!pkg.$field) process.exit(1)"; then
            echo "âœ… $field field present"
          else
            echo "âŒ $field field missing"
            exit 1
          fi
        done
        
        echo "âœ… package.json validation completed"

  validate-performance-files:
    name: ğŸ“Š Validate Performance Files
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Check performance optimization files
      run: |
        echo "ğŸ“Š Checking performance optimization files..."
        
        performance_files=(
          "PERFORMANCE_ANALYSIS.md"
          "IMPLEMENTATION_GUIDE.md"
          "lighthouse.config.js"
          "schema.sql"
        )
        
        workflow_files=(
          ".github/workflows/main.yml"
          ".github/workflows/validate.yml"
          ".github/workflows/simple.yml"
        )
        
        missing_performance=()
        missing_workflows=()
        
        for file in "${performance_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file exists"
            # Check if file is not empty
            if [ -s "$file" ]; then
              echo "  ğŸ“„ File has content"
            else
              echo "  âš ï¸ File is empty"
            fi
          else
            echo "âš ï¸ $file missing"
            missing_performance+=("$file")
          fi
        done
        
        for file in "${workflow_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file exists"
          else
            echo "âŒ $file missing (critical)"
            missing_workflows+=("$file")
          fi
        done
        
        # Report results
        if [ ${#missing_workflows[@]} -gt 0 ]; then
          echo "ğŸš¨ Missing critical workflow files: ${missing_workflows[*]}"
          exit 1
        fi
        
        if [ ${#missing_performance[@]} -gt 0 ]; then
          echo "ğŸ“ Missing performance files: ${missing_performance[*]}"
        fi
        
        echo "âœ… Performance files validation completed"

  validate-scripts:
    name: ğŸ”§ Validate Scripts & Dependencies
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.has-package-json == 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: Validate npm scripts
      run: |
        echo "ğŸ”§ Validating npm scripts..."
        
        # Check if scripts exist in package.json
        EXPECTED_SCRIPTS=(
          "build"
          "dev"
          "test"
          "lint"
        )
        
        missing_scripts=()
        
        for script in "${EXPECTED_SCRIPTS[@]}"; do
          if node -e "const pkg = JSON.parse(require('fs').readFileSync('package.json', 'utf8')); if (!pkg.scripts || !pkg.scripts.$script) process.exit(1)" 2>/dev/null; then
            echo "âœ… Script '$script' exists"
          else
            echo "âš ï¸ Script '$script' missing"
            missing_scripts+=("$script")
          fi
        done
        
        if [ ${#missing_scripts[@]} -gt 0 ]; then
          echo "ğŸ“ Missing scripts: ${missing_scripts[*]}"
        fi
        
        echo "âœ… Scripts validation completed"
        
    - name: Check dependencies
      run: |
        echo "ğŸ“¦ Checking dependencies..."
        
        # Install dependencies to check for issues
        if [ -f "package-lock.json" ]; then
          echo "ğŸ“‹ Using package-lock.json"
          if npm ci --dry-run; then
            echo "âœ… Dependencies can be installed"
          else
            echo "âš ï¸ Dependency installation issues detected"
          fi
        else
          echo "âš ï¸ No package-lock.json found"
          if npm install --dry-run; then
            echo "âœ… Dependencies can be installed"
          else
            echo "âš ï¸ Dependency installation issues detected"
          fi
        fi

  validate-deployment:
    name: ğŸš€ Validate Deployment Configuration
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Check deployment scripts
      run: |
        echo "ğŸš€ Checking deployment configuration..."
        
        deployment_files=(
          "deploy.sh"
          "Dockerfile"
          ".dockerignore"
        )
        
        optional_deployment=()
        
        for file in "${deployment_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file exists"
            if [ "$file" == "deploy.sh" ] && [ -x "$file" ]; then
              echo "  ğŸ”§ deploy.sh is executable"
            elif [ "$file" == "deploy.sh" ]; then
              echo "  âš ï¸ deploy.sh is not executable"
            fi
          else
            echo "ğŸ“ $file missing (optional)"
            optional_deployment+=("$file")
          fi
        done
        
        if [ ${#optional_deployment[@]} -gt 0 ]; then
          echo "ğŸ“ Optional deployment files missing: ${optional_deployment[*]}"
        fi
        
        echo "âœ… Deployment validation completed"

  security-check:
    name: ğŸ”’ Security Validation
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Check for sensitive files
      run: |
        echo "ğŸ”’ Checking for sensitive files..."
        
        # Files that should not be committed
        sensitive_patterns=(
          "*.env"
          "*.key"
          "*.pem"
          "*.p12"
          ".env.local"
          ".env.production"
          "config/secrets.json"
        )
        
        found_sensitive=()
        
        for pattern in "${sensitive_patterns[@]}"; do
          if find . -name "$pattern" -type f | grep -q .; then
            echo "âš ï¸ Found potentially sensitive files: $pattern"
            found_sensitive+=("$pattern")
          fi
        done
        
        if [ ${#found_sensitive[@]} -gt 0 ]; then
          echo "ğŸš¨ Sensitive files detected: ${found_sensitive[*]}"
          echo "ğŸ”§ Consider adding these to .gitignore"
        else
          echo "âœ… No sensitive files detected"
        fi
        
        # Check .gitignore exists and has common patterns
        if [ -f ".gitignore" ]; then
          echo "âœ… .gitignore exists"
          
          important_patterns=("node_modules/" "*.log" ".env")
          missing_patterns=()
          
          for pattern in "${important_patterns[@]}"; do
            if grep -q "$pattern" .gitignore; then
              echo "âœ… .gitignore includes $pattern"
            else
              echo "âš ï¸ .gitignore missing $pattern"
              missing_patterns+=("$pattern")
            fi
          done
          
          if [ ${#missing_patterns[@]} -gt 0 ]; then
            echo "ï¿½ Consider adding to .gitignore: ${missing_patterns[*]}"
          fi
        else
          echo "âŒ .gitignore missing"
        fi

  summary:
    name: ğŸ“‹ Validation Summary
    runs-on: ubuntu-latest
    needs: [validate, validate-performance-files, validate-scripts, validate-deployment, security-check]
    if: always()
    
    steps:
    - name: Generate validation summary
      run: |
        echo "ğŸ“‹ Validation Summary for ${{ needs.validate.outputs.project-name || 'Unknown Project' }}"
        echo "================================================"
        
        # Check results of all validation jobs
        if [ "${{ needs.validate.result }}" == "success" ]; then
          echo "âœ… Project Structure: PASSED"
        else
          echo "âŒ Project Structure: FAILED"
        fi
        
        if [ "${{ needs.validate-performance-files.result }}" == "success" ]; then
          echo "âœ… Performance Files: PASSED"
        else
          echo "âŒ Performance Files: FAILED"
        fi
        
        if [ "${{ needs.validate-scripts.result }}" == "success" ]; then
          echo "âœ… Scripts & Dependencies: PASSED"
        elif [ "${{ needs.validate-scripts.result }}" == "skipped" ]; then
          echo "â­ï¸ Scripts & Dependencies: SKIPPED"
        else
          echo "âŒ Scripts & Dependencies: FAILED"
        fi
        
        if [ "${{ needs.validate-deployment.result }}" == "success" ]; then
          echo "âœ… Deployment Config: PASSED"
        else
          echo "âŒ Deployment Config: FAILED"
        fi
        
        if [ "${{ needs.security-check.result }}" == "success" ]; then
          echo "âœ… Security Check: PASSED"
        else
          echo "âŒ Security Check: FAILED"
        fi
        
        echo "================================================"
        echo "ğŸ‰ Validation completed at $(date)"
