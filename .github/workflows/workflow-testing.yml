name: Workflow Testing & Validation

on:
  workflow_dispatch:
    inputs:
      test_scope:
        description: 'PortÃ©e du test'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - syntax-only
        - actions-only
        - security-only
      target_workflow:
        description: 'Workflow spÃ©cifique Ã  tester (optionnel)'
        required: false
        type: string
      dry_run:
        description: 'ExÃ©cution Ã  blanc (simulation)'
        required: true
        default: true
        type: boolean

env:
  NODE_VERSION: '18'

jobs:
  pre-test-validation:
    name: ğŸ” Validation PrÃ©-Test
    runs-on: ubuntu-latest
    
    outputs:
      workflows-to-test: ${{ steps.discover.outputs.workflows }}
      test-matrix: ${{ steps.matrix.outputs.matrix }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: DÃ©couvrir les workflows
      id: discover
      run: |
        echo "ğŸ” DÃ©couverte des workflows Ã  tester..."
        
        if [ -n "${{ github.event.inputs.target_workflow }}" ]; then
          # Test d'un workflow spÃ©cifique
          target="${{ github.event.inputs.target_workflow }}"
          if [ -f ".github/workflows/$target" ]; then
            echo "workflows=[\"$target\"]" >> $GITHUB_OUTPUT
            echo "ğŸ“„ Workflow cible: $target"
          else
            echo "âŒ Workflow $target introuvable"
            exit 1
          fi
        else
          # DÃ©couvrir tous les workflows
          workflows=$(find .github/workflows -name "*.yml" -o -name "*.yaml" | \
                     grep -v "workflow-testing.yml" | \
                     sed 's|.github/workflows/||' | \
                     jq -R -s -c 'split("\n")[:-1]')
          echo "workflows=$workflows" >> $GITHUB_OUTPUT
          echo "ğŸ“„ Workflows dÃ©couverts:"
          echo "$workflows" | jq -r '.[]' | sed 's/^/  - /'
        fi
        
    - name: GÃ©nÃ©rer la matrice de test
      id: matrix
      run: |
        echo "ğŸ¯ GÃ©nÃ©ration de la matrice de test..."
        
        # CrÃ©er la matrice basÃ©e sur le scope
        case "${{ github.event.inputs.test_scope }}" in
          "syntax-only")
            matrix='{"include":[{"test":"syntax","tool":"yamllint"},{"test":"syntax","tool":"actionlint"}]}'
            ;;
          "actions-only")
            matrix='{"include":[{"test":"actions","tool":"version-check"}]}'
            ;;
          "security-only")
            matrix='{"include":[{"test":"security","tool":"secrets-scan"}]}'
            ;;
          *)
            matrix='{"include":[{"test":"syntax","tool":"yamllint"},{"test":"syntax","tool":"actionlint"},{"test":"actions","tool":"version-check"},{"test":"security","tool":"secrets-scan"}]}'
            ;;
        esac
        
        echo "matrix=$matrix" >> $GITHUB_OUTPUT
        echo "ğŸ“Š Matrice de test:"
        echo "$matrix" | jq .

  syntax-testing:
    name: ğŸ” Test Syntaxe - ${{ matrix.tool }}
    runs-on: ubuntu-latest
    needs: pre-test-validation
    if: contains(needs.pre-test-validation.outputs.test-matrix, 'syntax')
    strategy:
      matrix: ${{ fromJson(needs.pre-test-validation.outputs.test-matrix) }}
      fail-fast: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup outils de validation
      run: |
        echo "ğŸ› ï¸ Installation des outils de validation..."
        
        if [ "${{ matrix.tool }}" = "yamllint" ]; then
          pip install yamllint
        elif [ "${{ matrix.tool }}" = "actionlint" ]; then
          bash <(curl https://raw.githubusercontent.com/rhymond/actionlint/main/scripts/download-actionlint.bash)
          sudo mv actionlint /usr/local/bin/
        fi
        
    - name: ExÃ©cuter les tests de syntaxe
      run: |
        echo "ğŸ§ª Test de syntaxe avec ${{ matrix.tool }}..."
        
        if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
          echo "ğŸ”„ Mode simulation activÃ©"
        fi
        
        case "${{ matrix.tool }}" in
          "yamllint")
            echo "ğŸ“ Configuration yamllint..."
            cat > .yamllint.yml << 'EOF'
        extends: default
        rules:
          line-length:
            max: 120
          indentation:
            spaces: 2
          truthy:
            allowed-values: ['true', 'false', 'on', 'off']
          document-start: disable
        EOF
            
            echo "ğŸ” Validation yamllint..."
            for workflow in $(echo '${{ needs.pre-test-validation.outputs.workflows }}' | jq -r '.[]'); do
              echo "ğŸ“„ Test de .github/workflows/$workflow"
              if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
                echo "  âœ… [SIMULATION] Syntaxe YAML valide"
              else
                yamllint ".github/workflows/$workflow"
              fi
            done
            ;;
            
          "actionlint")
            echo "ğŸ” Validation actionlint..."
            if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
              echo "âœ… [SIMULATION] Workflows valides selon actionlint"
            else
              actionlint .github/workflows/*.yml
            fi
            ;;
        esac

  action-version-testing:
    name: ğŸ”„ Test Versions Actions
    runs-on: ubuntu-latest
    needs: pre-test-validation
    if: contains(needs.pre-test-validation.outputs.test-matrix, 'actions')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Tester les versions d'actions
      run: |
        echo "ğŸ”„ Test des versions d'actions..."
        
        # Extraire toutes les actions utilisÃ©es
        actions_file="actions_to_test.txt"
        find .github/workflows -name "*.yml" -exec grep -h "uses:" {} \; | \
        sed 's/.*uses: *//' | sed 's/ *#.*//' | sort | uniq > "$actions_file"
        
        echo "ğŸ“„ Actions Ã  tester:"
        cat "$actions_file"
        
        if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
          echo "ğŸ”„ Mode simulation - vÃ©rification des actions..."
          while read -r action; do
            if [ -n "$action" ]; then
              echo "  âœ… [SIMULATION] $action - Disponible"
            fi
          done < "$actions_file"
        else
          # VÃ©rification rÃ©elle
          echo "ğŸŒ VÃ©rification rÃ©elle des actions..."
          unavailable=0
          
          while read -r action; do
            if [ -n "$action" ]; then
              repo="${action%@*}"
              version="${action#*@}"
              
              echo "ğŸ” Test de $action..."
              if curl -s -f "https://api.github.com/repos/$repo" > /dev/null; then
                if [ "$version" != "$repo" ]; then
                  if curl -s -f "https://api.github.com/repos/$repo/git/refs/tags/$version" > /dev/null; then
                    echo "  âœ… $action - Disponible"
                  else
                    echo "  âŒ $action - Version introuvable"
                    unavailable=$((unavailable + 1))
                  fi
                else
                  echo "  âœ… $action - Repository disponible"
                fi
              else
                echo "  âŒ $action - Repository introuvable"
                unavailable=$((unavailable + 1))
              fi
            fi
          done < "$actions_file"
          
          if [ $unavailable -gt 0 ]; then
            echo "ğŸš¨ $unavailable actions indisponibles dÃ©tectÃ©es"
            exit 1
          else
            echo "ğŸ‰ Toutes les actions sont disponibles"
          fi
        fi

  security-testing:
    name: ğŸ”’ Test SÃ©curitÃ©
    runs-on: ubuntu-latest
    needs: pre-test-validation
    if: contains(needs.pre-test-validation.outputs.test-matrix, 'security')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Scanner la sÃ©curitÃ© des workflows
      run: |
        echo "ğŸ”’ Scan de sÃ©curitÃ© des workflows..."
        
        security_issues=0
        
        # VÃ©rifier les secrets hardcodÃ©s
        echo "ğŸ” Recherche de secrets hardcodÃ©s..."
        secret_patterns=("password" "secret" "token" "key" "api_key")
        
        for pattern in "${secret_patterns[@]}"; do
          if find .github/workflows -name "*.yml" -exec grep -l -i "$pattern" {} \; | \
             xargs grep -v "secrets\." | grep -v "github\.token" | grep -v "description" | \
             grep -i "$pattern" >/dev/null 2>&1; then
            echo "âš ï¸ Potentiel secret hardcodÃ©: $pattern"
            security_issues=$((security_issues + 1))
          fi
        done
        
        # VÃ©rifier les permissions
        echo "ğŸ” VÃ©rification des permissions..."
        workflows_without_permissions=$(find .github/workflows -name "*.yml" -exec grep -L "permissions:" {} \; | wc -l)
        if [ "$workflows_without_permissions" -gt 0 ]; then
          echo "âš ï¸ $workflows_without_permissions workflows sans permissions explicites"
        fi
        
        # VÃ©rifier les actions tierces
        echo "ğŸ” VÃ©rification des actions tierces..."
        third_party_count=$(find .github/workflows -name "*.yml" -exec grep "uses:" {} \; | \
                           grep -v "actions/" | wc -l)
        if [ "$third_party_count" -gt 0 ]; then
          echo "âš ï¸ $third_party_count actions tierces dÃ©tectÃ©es"
          echo "ğŸ“‹ Actions tierces:"
          find .github/workflows -name "*.yml" -exec grep "uses:" {} \; | \
          grep -v "actions/" | sed 's/.*uses: */  - /'
        fi
        
        if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
          echo "âœ… [SIMULATION] Scan de sÃ©curitÃ© terminÃ©"
        else
          if [ $security_issues -gt 0 ]; then
            echo "ğŸš¨ $security_issues problÃ¨mes de sÃ©curitÃ© potentiels dÃ©tectÃ©s"
            echo "::warning::ProblÃ¨mes de sÃ©curitÃ© potentiels dans les workflows"
          else
            echo "âœ… Aucun problÃ¨me de sÃ©curitÃ© Ã©vident dÃ©tectÃ©"
          fi
        fi

  integration-testing:
    name: ğŸ§ª Test d'IntÃ©gration
    runs-on: ubuntu-latest
    needs: [syntax-testing, action-version-testing, security-testing]
    if: always() && (needs.syntax-testing.result == 'success' || needs.syntax-testing.result == 'skipped') && (needs.action-version-testing.result == 'success' || needs.action-version-testing.result == 'skipped') && (needs.security-testing.result == 'success' || needs.security-testing.result == 'skipped')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Test d'intÃ©gration des workflows
      run: |
        echo "ğŸ§ª Test d'intÃ©gration des workflows..."
        
        if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
          echo "ğŸ”„ Mode simulation - test d'intÃ©gration..."
          echo "âœ… [SIMULATION] Tous les workflows sont compatibles"
          echo "âœ… [SIMULATION] Aucun conflit de noms dÃ©tectÃ©"
          echo "âœ… [SIMULATION] DÃ©pendances entre jobs validÃ©es"
        else
          echo "ğŸ” VÃ©rification des conflits de noms de jobs..."
          job_conflicts=$(find .github/workflows -name "*.yml" -exec grep -h "^  [a-zA-Z].*:$" {} \; | \
                         sort | uniq -d | wc -l)
          
          if [ "$job_conflicts" -gt 0 ]; then
            echo "âš ï¸ Conflits de noms de jobs dÃ©tectÃ©s"
          else
            echo "âœ… Aucun conflit de noms de jobs"
          fi
          
          echo "ğŸ” VÃ©rification de la cohÃ©rence des dÃ©clencheurs..."
          echo "âœ… Test d'intÃ©gration terminÃ©"
        fi

  test-report:
    name: ğŸ“‹ Rapport de Test
    runs-on: ubuntu-latest
    needs: [pre-test-validation, syntax-testing, action-version-testing, security-testing, integration-testing]
    if: always()
    
    steps:
    - name: GÃ©nÃ©rer le rapport de test
      run: |
        echo "ğŸ“‹ GÃ©nÃ©ration du rapport de test..."
        
        cat > workflow-test-report.md << 'EOF'
        # ğŸ§ª Rapport de Test des Workflows
        
        **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        **PortÃ©e:** ${{ github.event.inputs.test_scope }}
        **Mode:** ${{ github.event.inputs.dry_run == 'true' && 'Simulation' || 'RÃ©el' }}
        **DÃ©clenchÃ© par:** ${{ github.actor }}
        
        ## ğŸ“Š RÃ©sultats des Tests
        
        | Test | Statut | DÃ©tails |
        |------|--------|---------|
        EOF
        
        # Ajouter les rÃ©sultats
        tests=(
          "syntax-testing:Test Syntaxe"
          "action-version-testing:Test Versions Actions"
          "security-testing:Test SÃ©curitÃ©"
          "integration-testing:Test IntÃ©gration"
        )
        
        for test_info in "${tests[@]}"; do
          test_name="${test_info%%:*}"
          test_desc="${test_info##*:}"
          
          case "$test_name" in
            "syntax-testing")
              result="${{ needs.syntax-testing.result }}"
              ;;
            "action-version-testing")
              result="${{ needs.action-version-testing.result }}"
              ;;
            "security-testing")
              result="${{ needs.security-testing.result }}"
              ;;
            "integration-testing")
              result="${{ needs.integration-testing.result }}"
              ;;
          esac
          
          case "$result" in
            "success")
              echo "| $test_desc | âœ… RÃ©ussi | Tous les tests passÃ©s |" >> workflow-test-report.md
              ;;
            "failure")
              echo "| $test_desc | âŒ Ã‰chec | Erreurs dÃ©tectÃ©es |" >> workflow-test-report.md
              ;;
            "skipped")
              echo "| $test_desc | â­ï¸ IgnorÃ© | Non inclus dans la portÃ©e |" >> workflow-test-report.md
              ;;
            *)
              echo "| $test_desc | â“ Inconnu | Statut non dÃ©terminÃ© |" >> workflow-test-report.md
              ;;
          esac
        done
        
        cat >> workflow-test-report.md << 'EOF'
        
        ## ğŸ’¡ Recommandations
        
        1. **Avant chaque modification** de workflow, exÃ©cuter ce test
        2. **Utiliser le mode simulation** pour les tests rapides
        3. **Tester en mode rÃ©el** avant le merge vers main
        4. **VÃ©rifier les actions** sur GitHub Marketplace
        
        ## ğŸ”— Actions Suivantes
        
        - [ ] Corriger les erreurs dÃ©tectÃ©es
        - [ ] Re-tester aprÃ¨s corrections
        - [ ] Valider en environnement de test
        - [ ] Merger les modifications
        
        EOF
        
        echo "âœ… Rapport gÃ©nÃ©rÃ©"
        
    - name: Upload du rapport
      uses: actions/upload-artifact@v4
      with:
        name: workflow-test-report
        path: workflow-test-report.md
        retention-days: 30
      if: always()
